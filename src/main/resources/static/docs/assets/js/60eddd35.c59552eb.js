"use strict";(self.webpackChunkclias_docs=self.webpackChunkclias_docs||[]).push([[5054],{8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>c});var s=i(6540);const a={},r=s.createContext(a);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},8794:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"dev/Notificaciones/notificaciones_envio_manual","title":"Notificaciones - Env\xedo manual (Script)","description":"\xbfPara qu\xe9 sirve?","source":"@site/docs/dev/Notificaciones/notificaciones_envio_manual.md","sourceDirName":"dev/Notificaciones","slug":"/dev/Notificaciones/notificaciones_envio_manual","permalink":"/docs/dev/Notificaciones/notificaciones_envio_manual","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Notificaciones - Env\xedo manual (Script)","sidebar_label":"Env\xedo manual (Script)","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Manejo en la app m\xf3vil","permalink":"/docs/dev/Notificaciones/notificaciones_movil"},"next":{"title":"Descripci\xf3n y Funcionalidades","permalink":"/docs/dev/chatbot/description"}}');var a=i(4848),r=i(8453);const o={title:"Notificaciones - Env\xedo manual (Script)",sidebar_label:"Env\xedo manual (Script)",sidebar_position:2},c=void 0,l={},t=[{value:"\xbfPara qu\xe9 sirve?",id:"para-qu\xe9-sirve",level:2},{value:"Flujo de alto nivel",id:"flujo-de-alto-nivel",level:2},{value:"Requisitos",id:"requisitos",level:2},{value:"Selecci\xf3n de destinatarias",id:"selecci\xf3n-de-destinatarias",level:2},{value:"Estructura de la notificaci\xf3n (payload)",id:"estructura-de-la-notificaci\xf3n-payload",level:2},{value:"Script de referencia (general)",id:"script-de-referencia-general",level:2},{value:"Ejemplo real: actualizaci\xf3n de app",id:"ejemplo-real-actualizaci\xf3n-de-app",level:2},{value:"Buenas pr\xe1cticas",id:"buenas-pr\xe1cticas",level:2},{value:"Variantes \xfatiles (opcionales)",id:"variantes-\xfatiles-opcionales",level:2}];function d(e){const n={blockquote:"blockquote",br:"br",code:"code",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"para-qu\xe9-sirve",children:"\xbfPara qu\xe9 sirve?"}),"\n",(0,a.jsxs)(n.p,{children:["Este script permite ",(0,a.jsx)(n.strong,{children:"enviar notificaciones masivas"})," a las usuarias ",(0,a.jsx)(n.strong,{children:"de forma inmediata"})," (no programada) cuando se requiere comunicar algo urgente u oportuno (por ejemplo, ",(0,a.jsx)(n.strong,{children:"actualizaci\xf3n de la app"}),", avisos operativos, mantenimiento, etc.).",(0,a.jsx)(n.br,{}),"\n","Se apoya en la ",(0,a.jsx)(n.strong,{children:"misma API del backend"})," que usa la app para crear notificaciones, y selecciona a las destinatarias consultando la base de datos para obtener los ",(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"publicId"})})," de cuentas con ",(0,a.jsx)(n.strong,{children:"token FCM v\xe1lido"}),"."]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Cu\xe1ndo usarlo"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Avisos globales no cubiertos por las automatizaciones."}),"\n",(0,a.jsx)(n.li,{children:"Campa\xf1as puntuales (ej. actualizaci\xf3n de app)."}),"\n",(0,a.jsxs)(n.li,{children:["Casos donde ",(0,a.jsx)(n.strong,{children:"no"})," se desea crear ni mantener una notificaci\xf3n programada."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"flujo-de-alto-nivel",children:"Flujo de alto nivel"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Carga variables de entorno (credenciales de BD, URL API)."}),"\n",(0,a.jsxs)(n.li,{children:["Consulta la tabla ",(0,a.jsx)(n.code,{children:"dispositivo_app_usuario"})," y re\xfane ",(0,a.jsx)(n.strong,{children:"usuarios \xfanicos"})," con ",(0,a.jsx)(n.code,{children:"fcm_token"})," v\xe1lido."]}),"\n",(0,a.jsxs)(n.li,{children:["Construye el ",(0,a.jsx)(n.strong,{children:"payload"})," de notificaci\xf3n (t\xedtulo, mensaje, tipo, acci\xf3n)."]}),"\n",(0,a.jsxs)(n.li,{children:["Env\xeda ",(0,a.jsx)(n.strong,{children:"una solicitud HTTP por usuaria"})," al endpoint ",(0,a.jsx)(n.code,{children:"/notificaciones"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Hace ",(0,a.jsx)(n.strong,{children:"pausas cortas"})," entre env\xedos para no saturar al backend/FCM."]}),"\n",(0,a.jsxs)(n.li,{children:["Imprime ",(0,a.jsx)(n.strong,{children:"\xe9xitos y errores"})," por cada intento."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"requisitos",children:"Requisitos"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Python 3.10+"}),"\n",(0,a.jsxs)(n.li,{children:["Dependencias: ",(0,a.jsx)(n.code,{children:"psycopg2"}),", ",(0,a.jsx)(n.code,{children:"requests"}),", ",(0,a.jsx)(n.code,{children:"python-dotenv"})]}),"\n",(0,a.jsxs)(n.li,{children:["Variables de entorno:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"SPRING_DATASOURCE_URL"})," (",(0,a.jsx)(n.code,{children:"postgresql://user:pass@host:5432/db"}),")"]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"SPRING_DATASOURCE_USERNAME"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"SPRING_DATASOURCE_PASSWORD"})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["Endpoint del backend accesible (por defecto: ",(0,a.jsx)(n.code,{children:"https://clias.ucuenca.edu.ec/notificaciones"}),")."]}),"\n"]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Instalaci\xf3n r\xe1pida"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"python -m venv .venv && source .venv/bin/activate\npip install psycopg2-binary requests python-dotenv\n"})}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"selecci\xf3n-de-destinatarias",children:"Selecci\xf3n de destinatarias"}),"\n",(0,a.jsxs)(n.p,{children:["Se consideran ",(0,a.jsx)(n.strong,{children:"todas las cuentas"})," que posean ",(0,a.jsx)(n.strong,{children:"al menos un dispositivo"})," con ",(0,a.jsxs)(n.strong,{children:[(0,a.jsx)(n.code,{children:"fcm_token"})," no vac\xedo"]}),":"]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Esto evita env\xedos a cuentas sin dispositivos v\xe1lidos y ",(0,a.jsx)(n.strong,{children:"deduplica"})," por usuaria."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"estructura-de-la-notificaci\xf3n-payload",children:"Estructura de la notificaci\xf3n (payload)"}),"\n",(0,a.jsxs)(n.p,{children:["Campos que el script env\xeda al backend (equivalentes a ",(0,a.jsx)(n.code,{children:"NotificacionRequest"}),"):"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"cuentaUsuarioPublicId"})," (UUID en texto) \u2014 destinataria"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"tipoNotificacion"})," (String) \u2014 tipo l\xf3gico de la notificaci\xf3n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"titulo"})," (String)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"mensaje"})," (String)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"tipoAccion"})," (String) \u2014 categoriza la acci\xf3n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"accion"})," (String) \u2014 ",(0,a.jsx)(n.strong,{children:"ruta interna"})," (p. ej. ",(0,a.jsx)(n.code,{children:"https://miapp.com/..."}),") o ",(0,a.jsx)(n.strong,{children:"URL externa"})]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Rutas internas vs externas"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Si ",(0,a.jsx)(n.code,{children:"accion"})," ",(0,a.jsx)(n.strong,{children:"empieza"})," con ",(0,a.jsx)(n.code,{children:"https://miapp.com/"}),", la app navega ",(0,a.jsx)(n.strong,{children:"dentro"})," de la app (pesta\xf1as, pantallas internas)."]}),"\n",(0,a.jsxs)(n.li,{children:["En caso contrario, la app abre un ",(0,a.jsx)(n.strong,{children:"di\xe1logo"})," con bot\xf3n ",(0,a.jsx)(n.strong,{children:"Navegar"})," para abrir la ",(0,a.jsx)(n.strong,{children:"URL externa"})," en el navegador del dispositivo."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Este dise\xf1o aporta ",(0,a.jsx)(n.strong,{children:"escalabilidad"}),": nuevos destinos se agregan sin tocar la l\xf3gica base, solo cambiando el valor de ",(0,a.jsx)(n.code,{children:"accion"}),"."]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"script-de-referencia-general",children:"Script de referencia (general)"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Nota:"})," ajusta ",(0,a.jsx)(n.code,{children:"ENDPOINT"}),", ",(0,a.jsx)(n.code,{children:"HEADERS"})," y los textos de la notificaci\xf3n seg\xfan el caso.",(0,a.jsx)(n.br,{}),"\n","Si tu API requiere JWT, agrega ",(0,a.jsx)(n.code,{children:"Authorization"})," al diccionario ",(0,a.jsx)(n.code,{children:"HEADERS"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'import os\nimport psycopg2\nimport requests\nfrom dotenv import load_dotenv\nimport time\n\n# 1) Variables de entorno\nload_dotenv()\nDB_URL = os.getenv("SPRING_DATASOURCE_URL")  # postgresql://user:pass@host:5432/dbname\nDB_USER = os.getenv("SPRING_DATASOURCE_USERNAME")\nDB_PASS = os.getenv("SPRING_DATASOURCE_PASSWORD")\n\n# 2) Endpoint backend\nENDPOINT = "https://<dominio>/notificaciones"\nHEADERS = {\n    "Content-Type": "application/json",\n    # "Authorization": "Bearer <TOKEN_JWT>",  # si se necesita\n}\n\n# 3) Contenido de la notificaci\xf3n (ejemplo: actualizaci\xf3n de app)\nTITULO = "Actualiza tu App SISA"\nMENSAJE = (\n    "Ya est\xe1 disponible la nueva versi\xf3n de la app. Ingresa a https://<dominio>/ "\n    "y ve al apartado \'Descarga la Aplicaci\xf3n M\xf3vil\'."\n)\nTIPO = "ACTUALIZACION_APP"\nTIPO_ACCION = "NUEVO_RECURSO"\nACCION = "https://clias.ucuenca.edu.ec/"\n\ndef obtener_usuarios():\n    conn = psycopg2.connect(DB_URL, user=DB_USER, password=DB_PASS)\n    cursor = conn.cursor()\n    query = \'\'\'\n        SELECT DISTINCT usuario_public_id::text\n        FROM dispositivo_app_usuario\n        WHERE fcm_token IS NOT NULL AND fcm_token <> \'\'\n    \'\'\'\n    cursor.execute(query)\n    resultados = cursor.fetchall()\n    cursor.close()\n    conn.close()\n    return [fila[0] for fila in resultados]\n\ndef enviar_notificacion(num_user, public_id):\n    payload = {\n        "cuentaUsuarioPublicId": public_id,\n        "tipoNotificacion": TIPO,\n        "titulo": TITULO,\n        "mensaje": MENSAJE,\n        "tipoAccion": TIPO_ACCION,\n        "accion": ACCION\n    }\n    try:\n        response = requests.post(ENDPOINT, json=payload, headers=HEADERS, timeout=20)\n        if response.status_code in (200, 201):\n            print(f"{num_user}) [OK] Notificaci\xf3n enviada a {public_id}")\n        else:\n            print(f"[X] Error {response.status_code} al enviar a {public_id}: {response.text}")\n    except Exception as e:\n        print(f"[X] Excepci\xf3n con {public_id}: {e}")\n\ndef main():\n    usuarios = obtener_usuarios()\n    print(f" Total usuarios a notificar: {len(usuarios)}")\n\n    #  Descomenta para ejecutar los env\xedos\n    # for i, public_id in enumerate(usuarios, start=1):\n    #     enviar_notificacion(i, public_id)\n    #     time.sleep(0.4)  # Evita saturar el backend/FCM\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsxs)(n.strong,{children:["Por qu\xe9 pausa (",(0,a.jsx)(n.code,{children:"time.sleep(0.4)"}),")"]}),(0,a.jsx)(n.br,{}),"\n","Para ",(0,a.jsx)(n.strong,{children:"limitar el rate"})," y evitar picos que generen errores de red, timeouts o bloqueos temporales en el backend/FCM."]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"ejemplo-real-actualizaci\xf3n-de-app",children:"Ejemplo real: actualizaci\xf3n de app"}),"\n",(0,a.jsxs)(n.p,{children:["El ejemplo incluido env\xeda una notificaci\xf3n con ",(0,a.jsx)(n.code,{children:'ACCION = "https://clias.ucuenca.edu.ec/"'}),".",(0,a.jsx)(n.br,{}),"\n","En la app, esto se muestra con un di\xe1logo y un bot\xf3n ",(0,a.jsx)(n.strong,{children:"Navegar"})," que abre el sitio del proyecto para descargar la nueva versi\xf3n."]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Ventaja: permite ",(0,a.jsx)(n.strong,{children:"campa\xf1as de actualizaci\xf3n"})," sin publicar una nueva versi\xf3n de la app."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"buenas-pr\xe1cticas",children:"Buenas pr\xe1cticas"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Probar en entorno de staging"})," con una muestra peque\xf1a antes del env\xedo masivo."]}),"\n",(0,a.jsxs)(n.li,{children:["Mantener ",(0,a.jsx)(n.strong,{children:"listas de exclusi\xf3n"})," (si corresponde) y revisar duplicados."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Autorizaci\xf3n"}),": si la API lo requiere, usar JWT con privilegios adecuados y ",(0,a.jsx)(n.strong,{children:"rotarlo"})," al finalizar."]}),"\n",(0,a.jsxs)(n.li,{children:["Registrar un ",(0,a.jsx)(n.strong,{children:"log"})," de resultados por ",(0,a.jsx)(n.code,{children:"public_id"})," (\xe9xito/error) para auditor\xeda y reintentos."]}),"\n",(0,a.jsxs)(n.li,{children:["Evitar mensajes ambiguos; incluir ",(0,a.jsx)(n.strong,{children:"call-to-action"})," claro (ej. \u201cNavegar\u201d, \u201cActualizar\u201d)."]}),"\n",(0,a.jsxs)(n.li,{children:["En campa\xf1as grandes, considerar ",(0,a.jsx)(n.strong,{children:"lotes"})," (batching) y m\xe9tricas de entrega/lectura."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"variantes-\xfatiles-opcionales",children:"Variantes \xfatiles (opcionales)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Filtro por cohorte"})," (ej. por fecha de registro o provincia) agregando cl\xe1usulas a la consulta SQL."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Lista acotada"}),": leer ",(0,a.jsx)(n.code,{children:"public_id"})," desde un archivo (CSV/JSON) para env\xedos segmentados."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Mensaje templado"}),": cargar ",(0,a.jsx)(n.code,{children:"TITULO/MENSAJE"})," desde un ",(0,a.jsx)(n.code,{children:".env"})," o un JSON de plantillas."]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);