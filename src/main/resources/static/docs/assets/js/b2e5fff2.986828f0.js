"use strict";(self.webpackChunkclias_docs=self.webpackChunkclias_docs||[]).push([[1625],{2075:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>x,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"dev/frontend_app/notificaciones_push","title":"App M\xf3vil SISA - Notificaciones Push","description":"Esta secci\xf3n resume c\xf3mo SISA integra Firebase Cloud Messaging (FCM), el flujo extremo a extremo desde el backend hasta la app, y los casos de uso principales. El objetivo es que cualquier desarrollador pueda mantener y extender el m\xf3dulo sin revisar c\xf3digo fuente.","source":"@site/docs/dev/frontend_app/notificaciones_push.md","sourceDirName":"dev/frontend_app","slug":"/dev/frontend_app/notificaciones_push","permalink":"/docs/dev/frontend_app/notificaciones_push","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"App M\xf3vil SISA - Notificaciones Push","sidebar_label":"Notificaciones Push","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Servicios y APIs","permalink":"/docs/dev/frontend_app/servicios_apis"},"next":{"title":"Configuraci\xf3n y Despliegue","permalink":"/docs/dev/frontend_app/configuracion_despliegue"}}');var r=i(4848),a=i(8453),o=i(6406);const c={title:"App M\xf3vil SISA - Notificaciones Push",sidebar_label:"Notificaciones Push",sidebar_position:5},d="Notificaciones Push (FCM)",t={},l=[{value:"Integraci\xf3n con Firebase Cloud Messaging",id:"integraci\xf3n-con-firebase-cloud-messaging",level:2},{value:"Flujo desde el backend hasta la app",id:"flujo-desde-el-backend-hasta-la-app",level:2},{value:"Registro/renovaci\xf3n del token (secuencia)",id:"registrorenovaci\xf3n-del-token-secuencia",level:2},{value:"Manejo del mensaje en la app (secuencia)",id:"manejo-del-mensaje-en-la-app-secuencia",level:2},{value:"Casos de uso principales (versi\xf3n compacta)",id:"casos-de-uso-principales-versi\xf3n-compacta",level:3}];function h(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components},{Details:i}=n;return i||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"notificaciones-push-fcm",children:"Notificaciones Push (FCM)"})}),"\n",(0,r.jsxs)(n.p,{children:["Esta secci\xf3n resume ",(0,r.jsx)(n.strong,{children:"c\xf3mo SISA integra Firebase Cloud Messaging (FCM)"}),", el ",(0,r.jsx)(n.strong,{children:"flujo extremo a extremo"})," desde el backend hasta la app, y los ",(0,r.jsx)(n.strong,{children:"casos de uso principales"}),". El objetivo es que cualquier desarrollador pueda mantener y extender el m\xf3dulo sin revisar c\xf3digo fuente."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"integraci\xf3n-con-firebase-cloud-messaging",children:"Integraci\xf3n con Firebase Cloud Messaging"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Componentes involucrados"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"notification_service.dart"})}),": registro/actualizaci\xf3n del token FCM y utilitarios del m\xf3dulo."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"firebase_messaging_handler.dart"})}),": recepci\xf3n y normalizaci\xf3n del mensaje (foreground, background, terminated)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"notification_state.dart"})}),": estado de notificaciones (banners, badges, bandeja, rutas)."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Puntos clave de la integraci\xf3n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["El ",(0,r.jsx)(n.strong,{children:"token FCM"})," se obtiene/actualiza tras un login exitoso y se ",(0,r.jsx)(n.strong,{children:"registra en el backend"})," vinculado al ",(0,r.jsx)(n.code,{children:"publicId"})," del usuario."]}),"\n",(0,r.jsxs)(n.li,{children:["Se distinguen ",(0,r.jsx)(n.strong,{children:"dos tipos de payload"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"notification"})})," (mostrado por el SO cuando la app est\xe1 en background/terminated)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"data"})})," (para ",(0,r.jsx)(n.em,{children:"deep-links"})," y l\xf3gica personalizada en la app; funciona en todas las situaciones)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Requisitos"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Proyecto Firebase configurado para la app (Android/iOS)."}),"\n",(0,r.jsxs)(n.li,{children:["Permisos de notificaciones habilitados en el SO (Android 13+/iOS requiere ",(0,r.jsx)(n.em,{children:"prompt"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Backend con endpoint para registrar el ",(0,r.jsx)(n.strong,{children:"token FCM"})," por usuario/dispositivo."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"flujo-desde-el-backend-hasta-la-app",children:"Flujo desde el backend hasta la app"}),"\n",(0,r.jsx)("div",{style:{display:"flex",justifyContent:"center",margin:"12px 0"},children:(0,r.jsx)("div",{style:{transform:"scale(0.9)",transformOrigin:"top center"},children:(0,r.jsx)(o.A,{value:'%%{init:{ "flowchart": { "useMaxWidth": false } }}%%\nflowchart LR\nBE[Backend CLIAS] --\x3e|envia| FCM[Firebase Cloud Messaging]\nFCM --\x3e|push| OS["SO del dispositivo"]\nOS --\x3e APP["App SISA"]\nAPP --\x3e HNDL["firebase_messaging_handler.dart"]\nHNDL --\x3e NST["notification_state.dart"]\nNST --\x3e UI["Pantallas / Widgets<br/>(banners, badges, rutas)"]\n'})})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Descripci\xf3n del flujo"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["El backend emite un evento (p. ej., ",(0,r.jsx)(n.strong,{children:"resultado listo"}),", ",(0,r.jsx)(n.strong,{children:"nuevo mensaje"}),", ",(0,r.jsx)(n.strong,{children:"recordatorio"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Env\xeda un push a ",(0,r.jsx)(n.strong,{children:"FCM"})," (a ",(0,r.jsx)(n.strong,{children:"token"})," o ",(0,r.jsx)(n.strong,{children:"topic"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["El ",(0,r.jsx)(n.strong,{children:"SO"})," entrega la notificaci\xf3n al dispositivo; si la app est\xe1 en background, muestra notificaci\xf3n nativa."]}),"\n",(0,r.jsxs)(n.li,{children:["La ",(0,r.jsx)(n.strong,{children:"App SISA"})," invoca ",(0,r.jsx)(n.code,{children:"firebase_messaging_handler.dart"})," para normalizar el mensaje."]}),"\n",(0,r.jsxs)(n.li,{children:["Se actualiza el ",(0,r.jsx)(n.strong,{children:"estado"})," en ",(0,r.jsx)(n.code,{children:"notification_state.dart"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["La ",(0,r.jsx)(n.strong,{children:"UI"})," reacciona (banner, badge, navegaci\xf3n por ",(0,r.jsx)(n.em,{children:"deep-link"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"registrorenovaci\xf3n-del-token-secuencia",children:"Registro/renovaci\xf3n del token (secuencia)"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant UI as Pantalla Login\n  participant SVC as AuthService\n  participant FCM as FCM SDK\n  participant NS as NotificationService\n  participant BE as Backend\n\n  UI->>SVC: login(usuario, clave)\n  SVC--\x3e>UI: sesi\xf3n OK (token, publicId)\n  UI->>FCM: obtenerToken()\n  FCM--\x3e>UI: tokenFCM\n  UI->>NS: registrarTokenFCM(publicId, tokenFCM)\n  NS->>BE: POST /notificaciones/registrar-token\n  BE--\x3e>NS: 200 OK"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Buenas pr\xe1cticas"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Reintentar el registro si falla (con backoff)."}),"\n",(0,r.jsxs)(n.li,{children:["Actualizar el token cuando ",(0,r.jsx)(n.strong,{children:"FCM lo renueva"})," (evento de ",(0,r.jsx)(n.em,{children:"token refresh"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"manejo-del-mensaje-en-la-app-secuencia",children:"Manejo del mensaje en la app (secuencia)"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant OS as SO del dispositivo\n  participant APP as App SISA\n  participant HNDL as firebase_messaging_handler.dart\n  participant NST as notification_state.dart\n  participant UI as UI (rutas/badges)\n\n  OS->>APP: push entrante (notification/data)\n  APP->>HNDL: onMessage / onBackgroundMessage\n  HNDL--\x3e>NST: normalizar y despachar (tipo, payload, ruta)\n  NST--\x3e>UI: actualizar estado (badge/banner)\n  UI--\x3e>UI: navegar si hay deep-link o acci\xf3n del usuario"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Casos a cubrir"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Foreground"}),": mostrar banner/di\xe1logo y actualizar contadores."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Background"}),": al tocar notificaci\xf3n, navegar a la pantalla (deep-link)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Terminated"}),": abrir app con ruta objetivo (usar inicializaci\xf3n con ",(0,r.jsx)(n.em,{children:"pending notification"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"casos-de-uso-principales-versi\xf3n-compacta",children:"Casos de uso principales (versi\xf3n compacta)"}),"\n",(0,r.jsx)("div",{style:{maxWidth:860,fontSize:"0.95rem",lineHeight:1.35},children:(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Caso"}),(0,r.jsx)(n.th,{children:"Descripci\xf3n"}),(0,r.jsx)(n.th,{children:"Acci\xf3n en la app"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Resultado disponible"})," (",(0,r.jsx)(n.code,{children:"RESULTADO"}),")"]}),(0,r.jsx)(n.td,{children:"Notifica resultado listo"}),(0,r.jsxs)(n.td,{children:["Marcar le\xedda \u2192 validar ",(0,r.jsx)(n.strong,{children:"ficha socioecon\xf3mica"})," y ",(0,r.jsx)(n.strong,{children:"encuesta"})," \u2192 navegar a ",(0,r.jsx)(n.strong,{children:"Resultado"})," (",(0,r.jsx)(n.code,{children:"mostrarResultadoDesdeContexto"}),"), ",(0,r.jsx)(n.strong,{children:"LikertSurveyPage"})," o ",(0,r.jsx)(n.strong,{children:"RequiredSocioeconomicForm"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Recordatorio (sin examen)"})," (",(0,r.jsx)(n.code,{children:"RECORDATORIO_NO_EXAMEN"}),")"]}),(0,r.jsx)(n.td,{children:"Retomar flujo principal"}),(0,r.jsxs)(n.td,{children:["Ir a ",(0,r.jsx)(n.strong,{children:"Dashboard"})," \u2192 ",(0,r.jsx)(n.code,{children:"irAPestanaPrincipal()"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Recordatorio: entrega"})," (",(0,r.jsx)(n.code,{children:"RECORDATORIO_NO_ENTREGA_DISPOSITIVO"}),")"]}),(0,r.jsx)(n.td,{children:"Confirmar entrega de dispositivo"}),(0,r.jsxs)(n.td,{children:["Mostrar di\xe1logo \u2192 si ",(0,r.jsx)(n.strong,{children:"S\xed"}),": ",(0,r.jsx)(n.code,{children:"desactivarRecordatorioEntrega(userId)"})," + SnackBar"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Acci\xf3n con enlace"})," (",(0,r.jsx)(n.code,{children:"accion"}),")"]}),(0,r.jsx)(n.td,{children:"Externo o interno"}),(0,r.jsxs)(n.td,{children:["Si ",(0,r.jsx)(n.strong,{children:"externo"}),": di\xe1logo + ",(0,r.jsx)(n.code,{children:"launchUrl(...)"})," \xb7 Si ",(0,r.jsx)(n.strong,{children:"interno"}),": ",(0,r.jsx)(n.code,{children:"irAPestanaRecursos()"})]})]})]})]})}),"\n",(0,r.jsxs)(i,{children:[(0,r.jsx)("summary",{children:"Otros casos"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Foreground:"})," notificaci\xf3n local con ",(0,r.jsx)(n.code,{children:"FlutterLocalNotificationsPlugin.show(...)"}),", refrescar ",(0,r.jsx)(n.strong,{children:"Dashboard"}),"/",(0,r.jsx)(n.strong,{children:"Notifications"}),", ",(0,r.jsx)(n.code,{children:"NotificacionFlags.hayNotificacionNueva = true"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Apertura desde notificaci\xf3n (background/terminated):"})," ",(0,r.jsx)(n.code,{children:"getInitialMessage()"})," / ",(0,r.jsx)(n.code,{children:"onMessageOpenedApp"})," \u2192 ",(0,r.jsx)(n.code,{children:"actualizarNotificacionesEnMemoria()"})," \u2192 ",(0,r.jsx)(n.code,{children:"manejarClickNotificacion(data)"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bienvenida local:"})," ",(0,r.jsx)(n.code,{children:"mostrarNotificacionBienvenidaLocal()"})," con ",(0,r.jsx)(n.code,{children:"AndroidNotificationDetails"}),"."]}),"\n"]})]}),"\n",(0,r.jsx)(n.hr,{})]})}function x(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);