"use strict";(self.webpackChunkclias_docs=self.webpackChunkclias_docs||[]).push([[8984],{4125:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"dev/Backend/security","title":"Backend - Seguridad","description":"---","source":"@site/docs/dev/Backend/security.md","sourceDirName":"dev/Backend","slug":"/dev/Backend/security","permalink":"/docs/dev/Backend/security","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Backend - Seguridad","sidebar_label":"Seguridad","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Web con thymeleaf & Static Assets","permalink":"/docs/dev/Backend/web_thymeleaf"},"next":{"title":"Despliegue","permalink":"/docs/dev/Backend/setup"}}');var s=i(4848),l=i(8453);const o={title:"Backend - Seguridad",sidebar_label:"Seguridad",sidebar_position:5},t=void 0,c={},a=[{value:"Enfoque general",id:"enfoque-general",level:2},{value:"Flujo (alto nivel)",id:"flujo-alto-nivel",level:2},{value:"Componentes clave de la configuraci\xf3n",id:"componentes-clave-de-la-configuraci\xf3n",level:2},{value:"<code>SecurityConfig</code>",id:"securityconfig",level:4},{value:"<code>JwtAuthenticationFilter</code>",id:"jwtauthenticationfilter",level:4},{value:"<code>CuentaUsuarioDetailService</code>",id:"cuentausuariodetailservice",level:4},{value:"C\xf3mo proteger / agregar endpoints (paso a paso)",id:"c\xf3mo-proteger--agregar-endpoints-paso-a-paso",level:2}];function d(e){const n={blockquote:"blockquote",br:"br",code:"code",h2:"h2",h4:"h4",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"enfoque-general",children:"Enfoque general"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Autenticaci\xf3n"}),": el usuario se loguea (p. ej. ",(0,s.jsx)(n.code,{children:"/api/auth/login"}),") y recibe un ",(0,s.jsx)(n.strong,{children:"JWT"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Autorizaci\xf3n"}),": en cada request posterior el cliente env\xeda el header",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.code,{children:"Authorization: Bearer <token>"}),".",(0,s.jsx)(n.br,{}),"\n","Un ",(0,s.jsx)(n.strong,{children:"filtro"})," (",(0,s.jsx)(n.code,{children:"JwtAuthenticationFilter"}),") valida el token y, si es correcto, ",(0,s.jsx)(n.strong,{children:"autentica"})," la petici\xf3n en el ",(0,s.jsx)(n.code,{children:"SecurityContext"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Sin sesi\xf3n de servidor"}),": el token contiene la identidad; el servidor no guarda estado de sesi\xf3n."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"flujo-alto-nivel",children:"Flujo (alto nivel)"}),"\n",(0,s.jsx)(n.mermaid,{value:"flowchart TB\n  A[Cliente\\n/login] --\x3e|user+pass| B[Auth Controller]\n  B --\x3e|JWT| C[Cliente]\n  C --\x3e|GET /api/... \\nAuthorization: Bearer <token>| D[JwtAuthenticationFilter]\n  D --\x3e|token v\xe1lido| E[SecurityContext \\ncon UserDetails]\n  E --\x3e F[Controlador de negocio]\n  D --\x3e|token inv\xe1lido| X[401/403]"}),"\n",(0,s.jsx)(n.h2,{id:"componentes-clave-de-la-configuraci\xf3n",children:"Componentes clave de la configuraci\xf3n"}),"\n",(0,s.jsx)(n.h4,{id:"securityconfig",children:(0,s.jsx)(n.code,{children:"SecurityConfig"})}),"\n",(0,s.jsx)(n.p,{children:"Puntos esenciales de la configuraci\xf3n:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CORS"}),": habilitado con ",(0,s.jsx)(n.code,{children:"CorsConfigurationSource"})," (actualmente ",(0,s.jsx)(n.code,{children:'allowedOriginPatterns=["*"]'})," )."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CSRF"}),": deshabilitado (",(0,s.jsx)(n.code,{children:"csrf.disable()"}),"), t\xedpico en APIs JWT."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Autorizaci\xf3n"}),": reglas con ",(0,s.jsx)(n.code,{children:"authorizeHttpRequests { \u2026 }"})," donde se define qu\xe9 rutas son p\xfablicas (",(0,s.jsx)(n.code,{children:"permitAll"}),") o requieren rol (",(0,s.jsx)(n.code,{children:"hasRole"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Filtro JWT"}),": ",(0,s.jsx)(n.code,{children:"addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)"})," para validar el token en ",(0,s.jsx)(n.strong,{children:"cada"})," request."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Autenticaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UserDetailsService"})," propio (",(0,s.jsx)(n.code,{children:"CuentaUsuarioDetailService"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"DaoAuthenticationProvider"})," + ",(0,s.jsx)(n.strong,{children:"BCrypt"})," para comparar contrase\xf1as hasheadas"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"AuthenticationManager"})," con ese provider"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"jwtauthenticationfilter",children:(0,s.jsx)(n.code,{children:"JwtAuthenticationFilter"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Extrae el token del header ",(0,s.jsx)(n.code,{children:"Authorization"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Lo valida (firma, expiraci\xf3n, etc.) y, si es v\xe1lido, ",(0,s.jsx)(n.strong,{children:"construye"})," un\n",(0,s.jsx)(n.code,{children:"UsernamePasswordAuthenticationToken"})," con el usuario/roles y lo deja en el\n",(0,s.jsx)(n.code,{children:"SecurityContext"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Si no hay token v\xe1lido \u2192 la request llegar\xe1 ",(0,s.jsx)(n.strong,{children:"no autenticada"})," y se aplican las reglas."]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"cuentausuariodetailservice",children:(0,s.jsx)(n.code,{children:"CuentaUsuarioDetailService"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Carga el usuario desde la BD (por email/username)."}),"\n",(0,s.jsxs)(n.li,{children:["Debe devolver un ",(0,s.jsx)(n.code,{children:"UserDetails"})," con ",(0,s.jsx)(n.strong,{children:"authorities"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Si usas ",(0,s.jsx)(n.code,{children:'hasRole("ADMIN")'}),", la autoridad esperada es ",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ROLE_ADMIN"})}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"c\xf3mo-proteger--agregar-endpoints-paso-a-paso",children:"C\xf3mo proteger / agregar endpoints (paso a paso)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Crea el endpoint en tu ",(0,s.jsx)(n.code,{children:"@RestController"})," o ",(0,s.jsx)(n.code,{children:"@Controller"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Decide si ser\xe1:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"p\xfablico"})," \u2192 ",(0,s.jsx)(n.code,{children:"permitAll()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"autenticado"})," \u2192 sin regla espec\xedfica; caer\xe1 en ",(0,s.jsx)(n.code,{children:"anyRequest().authenticated()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"por rol"})," \u2192 ",(0,s.jsx)(n.code,{children:'hasRole("ADMIN")'})," / ",(0,s.jsx)(n.code,{children:'hasRole("USER")'}),", etc."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Agrega la regla en ",(0,s.jsx)(n.code,{children:"authorizeHttpRequests"})," (cuanto antes, m\xe1s prioridad):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// Todo /api/reportes/* solo ADMIN\nregistry.requestMatchers("/api/reportes/**").hasRole("ADMIN")\n\n// Solo lectura p\xfablica en /api/medicos; resto autenticado\nregistry.requestMatchers(HttpMethod.GET, "/api/medicos/**").permitAll()\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Verifica que tus usuarios tengan la autoridad ROLE_XXX compatible."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Prueba con y sin token."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Orden importa"}),": Spring eval\xfaa matchers en el orden declarado. Pon las rutas m\xe1s espec\xedficas arriba."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>t});var r=i(6540);const s={},l=r.createContext(s);function o(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);